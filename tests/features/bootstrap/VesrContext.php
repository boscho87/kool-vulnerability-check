<?php

use Behat\Behat\Context\Context;
use Behat\Behat\Hook\Scope\BeforeScenarioScope;

/**
 * Features context.
 */
class VesrContext implements Context
{
	/** @var CommonContext $commonContext */
	private $commonContext;

	private $v11_filename;

	/**
	 * @param BeforeScenarioScope $scope
	 *
	 * @BeforeScenario
	 */
	public function gatherContexts(BeforeScenarioScope $scope)
	{
		$environment = $scope->getEnvironment();
		$this->commonContext = $environment->getContext(CommonContext::class);
	}

	/**
	 * @Given /^there is a new v11 file$/
	 *
	 * @todo create unique file on every execution
	 */
	public function iHaveANewV11file()
	{
		$filename = "automated_testing_" . date('YmdHis', time()) . ".v11";
		$string = "00201085706900000000000160201002002770400000035000076  020017080817080817080900005703000000000000000                          
00201085706900000000000160801002002672900000008000008  000017080717080717080800867151400000000000000                          
00201085706900000000000161101000003872200000100000076  020017082817082817082900125510500000000000000                          
01201085706900000000000170101997003690900000050008245  030017080917081017081100001009510000000000090                          
00201085706900000000000170101997004164100000050000076  020017083017083017083100253236700000000000000                          
01201085706900000000000170101997004487800000050008026  030017081117081417081500001001210000000000090                          
00201085706900000000000170101997004914600000030000076  020017082417082517082800908806800000000000000                          
11201085706900000000000170201002002636100000100009033  020017081017081117081400001004000000000000120                          
00201085706900000000000170201002002777500000100000076  020017082217082217082300746116300000000000000                          
00201085706900000000000170201002004381400000050000076  020017082417082417082500840366000000000000000                          
00201085706900000000000170201002005754500000030000040  040017080717080717080800529000100000000000000                          
11201085706900000000000170201002006335000000100008499  050017082917083017083100002008600000000000120                          
11201085706999900000000000000100006645100000030008499  030017080217080317080400001002300000000000090                          
00201085706999900000000000000100026713700000025000076  020017082917082917083000198109600000000000000                          
10201085706999900000000000000100026961900000040000014  420017080417080417080700096006600000000000000                          
11201085706999900000000000000100027928600000030008022  040017080417080717080800001013800000000000090                          
10201085706999900000000000000100028233800000020000014  430017081617081617081700014032100000000000000                          
10201085706999900000000000000100028570000000020000014  430017081617081617081700016011700000000000000                          
10201085706999900000000000000100029067000000030000014  420017083017083017083100134000800000000000000                          
00201085706999900000000000000100029281300000040000076  020017081817081817082100599313600000000000000                          
00201085706999900000000000000100029461000000050000076  020017082217082217082300746507600000000000000                          
00201085706999900000000000000100029575300000060000076  020017082417082517082800908511500000000000000                          
00201085706999900000000000000100029581200000010000076  020017080217080217080300651633600000000000000                          
00201085706999900000000000000100029695700000025000076  020017080817080817080900039204500000000000000                          
11201085706999900000000200000100026787900000020008149  020017080217080317080400001015110000000000090                          
00201085706999900000000200000100026866600000200000008  000017082417082417082500526466400000000000000                          
00201085706999900000000200000100027066300000035000076  020017080717080717080800984202700000000000000                          
00201085706999900000000200000100027069500000035000076  020017080217080217080300652490000000000000000                          
00201085706999900000000200000100027857500000050000076  020017080817080817080900005938300000000000000                          
01201085706999900000000200000100028116200000035008282  010017081617081717081800001001210000000000090                          
11201085706999900000000200000100028234900000050008126  020017080817080917081000001004810000000000090                          
00201085706999900000000200000100028846400000200000076  020017080817080917081000073109200000000000000                          
11201085706999900000000200000100028935800000035008335  020017083017083117090100001003010000000000090                          
00201085706999900000000200000100029674900000035000008  000017080817080817080900054476200000000000000                          
11201085706999900000000200000100029932700000030008451  010017082917083017083100001004710000000000090                          
10201085706999900000000200000100029978500000050000014  430017081017081017081100077024500000000000000                          
11201085706999900000000200000100029980400000030008358  020017081617081717081800001005610000000000090                          
00201085706999900000029700000100005792500000035000008  000017083117083117090100542067700000000000000                          
00201085706999900000029700000100009927300000035000076  020017081817081817082100562219900000000000000                          
00201085706999900000029700000100010023300000035000076  020017082417082417082500875206500000000000000                          
00201085706999900000029700000100010037600000035000076  020017082817082817082900094315500000000000000                          
00201085706999900000029700000100010038400000035000076  020017082817082817082900075009500000000000000                          
00201085706999900000029700000100016889100000035000008  000017082117082117082200186924700000000000000                          
00201085706999900000029700000100022693200000035000076  020017082417082417082500841745800000000000000                          
00201085706999900000029700000100023937100000200000076  020017082817082817082900052512400000000000000                          
01201085706999900000029700000100023956200000035008026  020017082417082517082800001002100000000000090                          
01201085706999900000029700000100026660500000035008282  010017082417082517082800001004200000000000090                          
00201085706999900000029700000100026906200000035000076  020017083017083017083100249213900000000000000                          
01201085706999900000029700000100026932400000035008246  030017081817082117082200001006000000000000090                          
00201085706999900000029700000100026965800000050000076  020017082817082817082900076627000000000000000                          
01201085706999900000029700000100026973600000035008057  020017082317082417082500001005600000000000090                          
00201085706999900000029700000100027124500000050000076  020017083117083117090100429407600000000000000                          
01201085706999900000029700000100027297900000035008295  020017082317082417082500001005000000000000090                          
00201085706999900000029700000100027367600000020000076  020017082517082817082900025211800000000000000                          
01201085706999900000029700000100027477100000035008214  030017082517082817082900001012400000000000090                          
00201085706999900000029700000100027499900000150000076  020017083117083117090100379141400000000000000                          
01201085706999900000029700000100027608400000035008439  020017082517082817082900001008900000000000090                          
00201085706999900000029700000100027622100000035000076  020017083017083017083100287213200000000000000                          
00201085706999900000029700000100027847900000030000076  020017082817082817082900059205000000000000000                          
00201085706999900000029700000100027898000000050000076  020017082517082517082800919999200000000000000                          
00201085706999900000029700000100027961500000050000076  020017083117083117090100412146500000000000000                          
01201085706999900000029700000100028173000000035008126  010017082117082217082300002001000000000000090                          
00201085706999900000029700000100028219100000020000076  020017082617082817082900027414900000000000000                          
00201085706999900000029700000100028498500000035000076  020017082917082917083000206923500000000000000                          
00201085706999900000029700000100028700500000035000076  020017083017083017083100249223400000000000000                          
11201085706999900000029700000100028741400000020008148  030017082417082517082800001000900000000000090                          
11201085706999900000029700000100028796300000050008089  040017082917083017083100001001300000000000090                          
00201085706999900000029700000100028808200000030000076  020017082917082917083000207809100000000000000                          
00201085706999900000029700000100028839300000035000076  020017083117083117090100374740600000000000000                          
00201085706999900000029700000100028874200000035000008  000017083017083017083100394289400000000000000                          
00201085706999900000029700000100029072300000035000076  020017082117082117082200633962500000000000000                          
00201085706999900000029700000100029119700000035000076  020017082917082917083000214614800000000000000                          
11201085706999900000029700000100029120200000030008499  030017082817082917083000001014700000000000090                          
00201085706999900000029700000100029165600000035000014  430017082317082317082400034019800000000000000                          
00201085706999900000029700000100029176900000035000076  020017083117083117090100356686800000000000000                          
00201085706999900000029700000100029229700000035000076  020017082917082917083000207808000000000000000                          
11201085706999900000029700000100029326400000020008376  030017082617082817082900001017400000000000090                          
00201085706999900000029700000100029331600000035000014  420017082917082917083000098002500000000000000                          
00201085706999900000029700000100029340400000050000008  000017083017083017083100133172900000000000000                          
00201085706999900000029700000100029349600000010000008  000017083017083017083100342249200000000000000                          
00201085706999900000029700000100029363400000035000076  020017082817082817082900124131500000000000000                          
00201085706999900000029700000100029371000000035000076  020017083117083117090100356925700000000000000                          
00201085706999900000029700000100029512900000050000076  020017082917082917083000216511100000000000000                          
00201085706999900000029700000100029544700000020000076  020017082917082917083000205319200000000000000                          
00201085706999900000029700000100029659000000035000076  020017082617082817082900027306200000000000000                          
00201085706999900000029700000100029775400000035000076  020017082417082417082500886003500000000000000                          
11201085706999900000029700000100029938800000010008557  020017081817082117082200001011900000000000090                          
01201085706999900000029700000100030130100000035000014  110017082317082417082500019005700000000000090                          
10201085706999900000029700000100030159200000010000014  430017082517082517082800066012300000000000000                          
10201085706999900000029700000100030196600000020000014  430017082217082217082300019031000000000000000                          
00201085706999900000029700000100030233700000035000076  020017082817082817082900104537400000000000000                          
00201085706999900000029700000100030245800000035000040  040017082517082517082800965000100000000000000                          
01201085706999900000029700000100032292600000035006004  120017081917082117082200001003100000000000090                          
00201085706999900000029700000100032318300000010000076  020017082817082817082900061861700000000000000                          
00201085706999900000029700000100032398600000035000076  020017082917083017083100239113100000000000000                          
00201085706999900000029700000100032409100000035000076  020017082817082817082900076826100000000000000                          
00201085706999900000029700000100032428500000050000008  000017082817082817082900993376600000000000000                          
999010857069999999999999999999999999999000000418300000000000097170831000002490000000084";
		file_put_contents("./temp/" . $filename, $string);

		$this->v11_filename = $filename;
	}

	/**
	 * @Then /^(?:|I )send this file via mail$/
	 */
	public function iSendThisFileViaMail()
	{
		$transport = Swift_SmtpTransport::newInstance($this->commonContext->config['mail']['host'],587,'tls');
		$transport->setUsername($this->commonContext->config['mail']['username'])->setPassword($this->commonContext->config['mail']['password']);

		$mailer = Swift_Mailer::newInstance($transport);

		Swift_Preferences::getInstance()->setCharset('iso-8859-1');
		$message = Swift_Message::newInstance();
		$body = "This is a dummy VESR payment file sent from behat.";
		$subject = "VESR payment file";
		$from = $this->commonContext->config['mail']['username'];
		$to = $this->commonContext->config['mail']['username'];

		$message->setBody($body)->setSubject($subject)->setFrom($from)->setTo($to);

		$message->attach(
			Swift_Attachment::fromPath('./temp/' . $this->v11_filename)->setFilename($this->v11_filename)
		);

		$mailer->send($message, $failures);
	}

	/**
	 * @When /^(?:|I )execute task "(?P<rowText>[^"]+)"$/
	 */
	public function iExecuteTheTask($rowText)
	{
		$row = $this->commonContext->getSession()->getPage()->find('css', sprintf('table tr:contains("%s")', $rowText));
		$link = $row->find('css', 'a');
		$link->click();
	}

	/** @AfterScenario */
	public function cleanup($event) {

		$files = glob('./temp/*.v11');
		foreach($files as $file){
			if(is_file($file))
				unlink($file);
		}


		$v11_dir = $this->commonContext->config['base_dir'] . '/my_images/v11/';
		$files = glob($v11_dir . '*.v11');
		foreach($files as $file){
			if(is_file($file))
				unlink($file);
		}

		@unlink($v11_dir. 'report_esr_import.pdf');
		@unlink('./temp/report_esr_import.pdf');
	}

}